{"version":3,"file":"plugins/plugin.iiif.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/plugins/plugin.iiif.js"],"sourcesContent":["// @ts-check\nconst BookReader = /** @type {typeof import('../BookReader').default} */(window.BookReader);\n\nexport const DEFAULT_OPTIONS = {\n  enabled: true,\n  /** @type {import('@iiif/presentation-3').Manifest | import('@iiif/presentation-2').Manifest} */\n  manifest: null,\n};\n\nclass IIIFPlugin {\n  constructor(options = DEFAULT_OPTIONS, optionVariables) {\n    this.options = options;\n    this.optionVariables = optionVariables;\n    this.manifest = options.manifest;\n  }\n\n  load() {\n    if (this.manifest[\"@context\"] == \"http://iiif.io/api/presentation/2/context.json\") {\n      const manifest = /** @type {import('@iiif/presentation-2').Manifest} */(this.manifest);\n      return this.manifestToBookReaderV2(manifest);\n    } else if (this.manifest[\"@context\"] == \"http://iiif.io/api/presentation/3/context.json\") {\n      const manifest = /** @type {import('@iiif/presentation-3').Manifest} */(this.manifest);\n      return this.manifestToBookReaderV3(manifest);\n    } else {\n      throw new Error(\"Unsupported IIIF context \" + this.manifest[\"@context\"]);\n    }\n  }\n\n  /**\n   * @param {import('@iiif/presentation-3').Manifest} manifest\n   */\n  manifestToBookReaderV3(manifest) {\n    /** @type {import('../BookReader/options.js').BookReaderOptions} */\n    const book = {\n      bookTitle: resolveInternationalString(manifest.label),\n      pageProgression: manifest.viewingDirection == \"right-to-left\" ? \"rl\" : \"lr\",\n      // numLeafs: manifest.items.length,\n      metadata: manifest.metadata.map((metadata) => {\n        return {\n          label: resolveInternationalString(metadata.label),\n          value: resolveInternationalString(metadata.value),\n        };\n      }),\n      data: [],\n      /**\n       * @this {import('../BookReader.js').default}\n       */\n      getPageURI(pageIndex, reduce, rotate) {\n        const percent = Math.floor(100 * 1 / reduce);\n        const bodyArr = manifest.items[pageIndex].items[0].items[0].body;\n        const body = bodyArr instanceof Array ? bodyArr[0] : bodyArr;\n        const uri = body.service[0].id;\n        return `${uri}/full/pct:${percent}/0/default.jpg`;\n      }\n    };\n\n    if (manifest.viewingDirection == \"top-to-bottom\" || manifest.viewingDirection == \"bottom-to-top\") {\n      console.warn(\"Unsupported viewingDirection\", manifest.viewingDirection);\n    }\n\n    let spread = [];\n    manifest.items.forEach((item, index) => {\n      const bodyArr = manifest.items[index].items[0].items[0].body;\n      const body = bodyArr instanceof Array ? bodyArr[0] : bodyArr;\n      const uri = body.service[0].id;\n      /** @type {import('../BookReader/options.js').PageData} */\n      const pageData = {\n        uri,\n        width: item.width,\n        height: item.height,\n        pageNum: resolveInternationalString(item.label),\n      };\n      spread.push(pageData);\n      if (index % 2 == 0) {\n        book.data.push(spread);\n        spread = [];\n      }\n    });\n\n    return book;\n  }\n\n  /**\n   * @param {import('@iiif/presentation-2').Manifest} manifest\n   */\n  manifestToBookReaderV2(manifest) {\n    /** @type {import('../BookReader/options.js').BookReaderOptions} */\n    const book = {\n      bookTitle: manifest.label,\n      metadata: manifest.metadata,\n      thumbnail: manifest.thumbnail?.['@id'],\n      // numLeafs: manifest.sequences[0].canvases.length,\n      data: [],\n      /**\n       * @this {import('../BookReader.js').default}\n       */\n      getPageURI(pageIndex, reduce, rotate) {\n        const percent = Math.floor(100 * 1 / reduce);\n        const uri = manifest.sequences[0].canvases[pageIndex].images[0].resource.service['@id'];\n        return `${uri}/full/pct:${percent}/0/default.jpg`;\n      }\n    };\n\n    let spread = [];\n    manifest.sequences[0].canvases.forEach((canvas, index) => {\n      /** @type {import('../BookReader/options.js').PageData} */\n      const pageData = {\n        uri: canvas.images[0].resource.service['@id'],\n        width: canvas.width,\n        height: canvas.height,\n        pageNum: canvas.label,\n      };\n      spread.push(pageData);\n      if (index % 2 == 0) {\n        book.data.push(spread);\n        spread = [];\n      }\n    });\n\n    return book;\n  }\n}\n\n/**\n * @param {import('@iiif/presentation-3').InternationalString} internationalString\n */\nfunction resolveInternationalString(internationalString) {\n  const anyLang = Object.keys(internationalString)[0];\n  return (internationalString[navigator.language] || internationalString[anyLang])[0];\n}\n\nexport class BookReaderWithIIIFPlugin extends BookReader {\n  setup(options) {\n    const pluginOpts = Object.assign(\n      {},\n      DEFAULT_OPTIONS,\n      options.plugins.iiif,\n    );\n\n    if (pluginOpts.enabled) {\n      this.iiifPlugin = new IIIFPlugin(pluginOpts, options.vars);\n      // Write this back; this way the plugin is the source of truth, and BR just\n      // contains a reference to it.\n      options.plugins.iiif = this.iiifPlugin.options;\n      Object.assign(options, this.iiifPlugin.load());\n    }\n    return super.setup(options);\n  }\n}\nwindow.BookReader = BookReaderWithIIIFPlugin;\nexport default BookReaderWithIIIFPlugin;\n"],"names":["BookReader","window","DEFAULT_OPTIONS","enabled","manifest","IIIFPlugin","options","arguments","length","undefined","optionVariables","_classCallCheck","this","_createClass","key","value","manifestToBookReaderV2","manifestToBookReaderV3","Error","book","bookTitle","resolveInternationalString","label","pageProgression","viewingDirection","metadata","map","data","getPageURI","pageIndex","reduce","rotate","percent","Math","floor","bodyArr","items","body","uri","Array","service","id","concat","console","warn","spread","forEach","item","index","pageData","width","height","pageNum","push","_manifest$thumbnail","thumbnail","sequences","canvases","images","resource","canvas","internationalString","anyLang","Object","keys","navigator","language","BookReaderWithIIIFPlugin","_BookReader","_inherits","_super","apply","pluginOpts","assign","plugins","iiif","iiifPlugin","vars","load","_get","_getPrototypeOf","prototype","call"],"sourceRoot":""}