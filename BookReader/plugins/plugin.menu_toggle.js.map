{"version":3,"sources":["webpack://@internetarchive/bookreader/./src/js/plugins/menu_toggle/plugin.menu_toggle.js"],"names":["jQuery","extend","BookReader","defaultOptions","enableMenuToggle","holdOffOnToggle","hideArrow","br","refs","$BRnav","children","css","initialX","initialY","togglingNav","toggleRouter","e","atBookCenter","brContainer","element","book","document","querySelector","scrollWidth","offsetWidth","$brContainer","currentTarget","validBookClick","constMode1up","mode","event","clickPosition","clientX","bookWidth","leftOffset","offsetLeft","bookEndPageFlipArea","Math","round","leftThreshold","rightThreshold","isCenterClick","target","$","hasClass","on","navToggled","window","removeEventListener","navigationIsVisible","hideNavigation","showNavigation","toggleNav","stopPropagation","onBackgroundClick","onBookClick","registerClickHandlers","background","addEventListener","bind","capture","passive","firstChild","screenX","screenY","abs","registerDragHandlers","super_","installMenuToggle","hasNav","error","menuToggleEventRegister","setupDOMandHandlers","setupNavForToggle","join","$brPageViewEl","$brTwoPageView","removeClickHandlers","alwaysShowNav","prototype","setup","options","call","this","init"],"mappings":"gLAqBA,WACEA,EAAOC,OAAOC,WAAWC,eAAgB,CACvCC,kBAAkB,IAQpB,IAAIC,GAAkB,EAOtB,SAASC,EAAUC,GACZA,EAAGC,MAASD,EAAGC,KAAKC,QAGRF,EAAGC,KAAKC,OAAOC,SAAS,cAChCC,IAAI,UAAW,QA8B1B,IAmIIC,EACAC,EApHAC,GAAc,EA4EZC,EAAe,SAAuBR,EAAIS,EAAGC,GACjD,IAAIZ,EAAJ,CAIA,IAtDMa,EAgCmCC,EAsBnCC,GAtDAF,EAAcG,SAASC,cAAc,iBACXC,YACZL,EAAYM,YAoDSjB,EAAGC,KAAKiB,aAAa,GAAKT,EAAEU,cAE/DC,EADYpB,EAAGqB,eAAiBrB,EAAGsB,MA1CrB,SAAuBC,EAAOV,GAClD,IAAMW,EAAgBD,EAAME,QACtBC,EAAYb,EAAKI,YACjBU,EAAad,EAAKe,WAClBC,EAAsBC,KAAKC,MAAML,EAAY,GAC7CM,EAAgBF,KAAKC,MAAMF,EAAsBF,GACjDM,EAAiBH,KAAKC,MAAML,EAAYG,EAAsBF,GAKpE,OAJoBH,EAAgBQ,GACjBR,EAAgBS,EAmCCC,CAAczB,EAAGI,IAC5BH,EAAeU,GAzBCR,EAyB6BH,EAAE0B,OAxB9CC,EAAExB,GAASyB,SAAS,eACvCD,EAAExB,GAASyB,SAAS,gBACpBD,EAAExB,GAASyB,SAAS,gBACpBD,EAAExB,GAASyB,SAAS,eACpBD,EAAExB,GAASyB,SAAS,qBA/DX,SAAmBrC,GAC/BO,IAIJA,GAAc,EAKd6B,EAAEtB,UAAUwB,GAAG,yBAJI,SAASC,IAC1BhC,GAAc,EACdiC,OAAOC,oBAAoB,wBAAyBF,MAIhCvC,EAAG0C,sBAEvB1C,EAAG2C,iBAEH3C,EAAG4C,kBAqEHC,CAAU7C,GAENU,GACFD,EAAEqC,qBAUR,SAASC,EAAkB/C,EAAIS,GAC7BD,EAAaR,EAAIS,GASnB,SAASuC,EAAYhD,EAAIS,GAGvBD,EAAaR,EAAIS,GADI,GAqCvB,SAASwC,EAAsBjD,GAC7B,IAAMkD,EAAapC,SAASC,cAAc,eAC1C,GAAKmC,EAAL,CAIAA,EAAWC,iBAAiB,QAASJ,EAAkBK,KAAK,KAAMpD,GAAK,CAAEqD,SAAS,EAAMC,SAAS,IAEjG,IACMzC,GADOC,SAASC,cAAc,iBAAmB,IACrCwC,WAEd1C,IACFA,EAAKsC,iBAAiB,QAASH,EAAYI,KAAK,KAAMpD,IAAK,GAvC/D,WACE,IAAMkD,EAAapC,SAASC,cAAc,eACrCmC,IAILA,EAAWC,iBAAiB,aAAa,SAAU1C,GACjDJ,EAAWI,EAAE+C,QACblD,EAAWG,EAAEgD,QAEb3D,GAAkB,KACjB,GACHoD,EAAWC,iBAAiB,WAAW,SAAU1C,GAC/BqB,KAAK4B,IAAIrD,EAAWI,EAAE+C,SAAW,GAAK1B,KAAK4B,IAAIpD,EAAWG,EAAEgD,SAAW,IAGrF3D,GAAkB,EAClBO,EAAW,EACXC,EAAW,MAEZ,IAoBDqD,KAQJ,IAgDuCC,EAhDjCC,EAAoB,SAA2B7D,GACnD,IAAI8D,GAAS,EAEb,IACEA,EAAS9D,EAAG0C,sBACZ,MAAOqB,GACPD,GAAS,EAGX,GAAKA,EAAL,CAIA,IAAME,EAA0B,SAAiCvD,GAC/DwC,EAAsBjD,IAGlBiE,EAAsB,SAA6BxD,IAhO3D,SAA2BT,GACzBD,EAAUC,GACViD,EAAsBjD,GA+NpBkE,CAAkBlE,IAmBpBoC,EAAEtB,UAAUwB,GAJmB,CAC7B,gCAGoC6B,KAAK,MAhBxB,SAAoB1D,IAzNzC,SAAuBT,GACrBD,EAAUC,GAUgB,SAA6BA,GACnDA,EAAGC,KAAKmE,eACVpE,EAAGC,KAAKmE,cAAc,GAAG3B,oBAAoB,QAASO,GAAa,GAEjEhD,EAAGC,KAAKoE,gBACVrE,EAAGC,KAAKoE,eAAe,GAAG5B,oBAAoB,QAASO,GAAa,GAdtEsB,CAAoBtE,GACpBA,EAAG4C,iBAuND2B,CAAcvE,MAgBhBoC,EAAEtB,UAAUwB,GAbY,CACtB,+BACA,+BACA,oBACA,qBACA,qBAQ6B6B,KAAK,KAAMH,GAC1C5B,EAAEI,QAAQF,GAAG,oBAAqB0B,GAClC5B,EAAEtB,UAAUwB,GAAG,+BAAgC2B,GAC/C7B,EAAEI,QAAQF,GAAG,mBAAoB2B,GACjCA,MAMFtE,WAAW6E,UAAUC,OAAkBb,EAIpCjE,WAAW6E,UAAUC,MAHf,SAASC,GACdd,EAAOe,KAAKC,KAAMF,KAOtB/E,WAAW6E,UAAUK,KAAQ,SAASjB,GACpC,OAAO,WACLA,EAAOe,KAAKC,MACRA,KAAKF,QAAQ7E,kBACfgE,EAAkBe,OAJK,CAO1BjF,WAAW6E,UAAUK,MA7S1B,K","file":"plugins/plugin.menu_toggle.js","sourcesContent":["\n/* global BookReader */\n/**\n * Plugin for managing menu visibility\n * Enabling this plug-in:\n * + removes the \"menu tab\" triangle\n * + toggles nav at: book center tap/click\n * + toggles nav at: black background tap/click\n *\n * Handles to events at CAPTURE phase\n *\n * This uses core BookReader functions and parameters to check its UI state:\n * - br.refs = (at best) ui references that are present at any given time\n * - br.navigationIsVisible() - checks using refs to confirm the navbar's presence\n * - br.showNavigation() & br.hideNavigation()\n * - br.constMode1up checks against br.mode;\n *\n * The list of BookReader custom events this plugin taps into are mainly\n * listed in the `.init` function\n */\n\n(function addMenuToggler() {\n  jQuery.extend(BookReader.defaultOptions, {\n    enableMenuToggle: true\n  });\n\n  /**\n     * `holdOffOnToggle` is used in fn `toggleRouter`\n     * to determine if menu toggle should happen\n     * set by `registerDragHandlers`\n     */\n  let holdOffOnToggle = false;\n\n  /**\n     * Hides Nav arrow tab\n     *\n     * @param { object } br - BookReader instance\n     */\n  function hideArrow(br) {\n    if (!br.refs || !br.refs.$BRnav) {\n      return;\n    }\n    const $menuTab = br.refs.$BRnav.children('.BRnavCntl');\n    $menuTab.css('display', 'none');\n  }\n\n  /**\n     * Sets up nav - hides arrow tab & adds click events\n     *\n     * @param { object } br - BookReader instance\n     */\n  function setupNavForToggle(br) {\n    hideArrow(br);\n    registerClickHandlers(br);\n  }\n\n  /**\n     * Resets nav to always show\n     * hides arrow tab, removes click events, shows nav chrome\n     *\n     * @param { object } br - BookReader instance\n     */\n  function alwaysShowNav(br) {\n    hideArrow(br);\n    removeClickHandlers(br);\n    br.showNavigation();\n  }\n\n  /**\n     * Removes click handlers on elements that house the book pages\n     *\n     * @param { object } br - BookReader instance\n     */\n  const removeClickHandlers = function removeClickHandlers(br) {\n    if (br.refs.$brPageViewEl) {\n      br.refs.$brPageViewEl[0].removeEventListener('click', onBookClick, true);\n    }\n    if (br.refs.$brTwoPageView) {\n      br.refs.$brTwoPageView[0].removeEventListener('click', onBookClick, true);\n    }\n  }\n\n  /**\n     * Toggle functionality\n     * Responsible for calling native functions `hideNavigation` & `showNavigation`\n     * Makes sure only 1 toggle action is taken at a time using `togglingNav` switch.\n     *\n     * @params { object } br - bookreader instance\n     */\n  let togglingNav = false; /* flag to make sure animations only fire once */\n  const toggleNav = function toggleNav(br) {\n    if (togglingNav) {\n      return;\n    }\n\n    togglingNav = true;\n    const navToggled = function navToggled() {\n      togglingNav = false;\n      window.removeEventListener('BookReader:navToggled', navToggled);\n    };\n    $(document).on('BookReader:navToggled', navToggled);\n\n    const menuIsShowing = br.navigationIsVisible();\n    if (menuIsShowing) {\n      br.hideNavigation();\n    } else {\n      br.showNavigation();\n    }\n  }\n\n  /**\n     * Check if div `BRcontainer` is scrollable.\n     * This normally happens when bookreader is zoomed in.\n     * not using br.refs, because `scrollWidth` & `offsetWidth` is not easily accessible.\n     */\n  const isBRcontainerScrollable = function isBRcontainerScrollable() {\n    const brContainer = document.querySelector('.BRcontainer');\n    const scrollWidth = brContainer.scrollWidth;\n    const offsetWidth = brContainer.offsetWidth;\n\n    return scrollWidth > offsetWidth;\n  }\n\n  /**\n     * Confirms whether or not the click happened in the nav toggle zone\n     *\n     * @param { MouseEvent } event - JS click event object\n     * @param { DOM } book - DOM element that represents book\n     */\n  const isCenterClick = function isCenterClick(event, book) {\n    const clickPosition = event.clientX;\n    const bookWidth = book.offsetWidth;\n    const leftOffset = book.offsetLeft\n    const bookEndPageFlipArea = Math.round(bookWidth / 3);\n    const leftThreshold = Math.round(bookEndPageFlipArea + leftOffset); // without it, the click area is small\n    const rightThreshold = Math.round(bookWidth - bookEndPageFlipArea + leftOffset);\n    const isOkOnRight = clickPosition > leftThreshold;\n    const isOkOnLeft = clickPosition < rightThreshold;\n    const isCenterClick = isOkOnRight && isOkOnLeft;\n\n    return isCenterClick;\n  }\n\n  /**\n     * Confirms whether or not the click happened in the background\n     *\n     * @param { DOM } element\n     */\n  const isBackground = function isBackground(element) {\n    const isBackgroundClick = $(element).hasClass('BookReader')\n        || $(element).hasClass('BRcontainer') /* main black theatre */\n        || $(element).hasClass('BRemptypage') /* empty page placeholder */\n        || $(element).hasClass('BRpageview') /* empty page placeholder, 1up */\n        || $(element).hasClass('BRtwopageview'); /* empty page placeholder, 2up */\n    return isBackgroundClick;\n  };\n\n  /**\n     * Main hook into toggle functionality\n     * This is the only function that should be called by the event handlers\n     *\n     * @param { object } br - BookReader instance\n     * @param { MouseEvent } e - JS event object\n     * @param { boolean } atBookCenter - optional\n     */\n  const toggleRouter = function toggleRouter (br, e, atBookCenter) {\n    if (holdOffOnToggle) {\n      return;\n    }\n\n    const book = isBRcontainerScrollable() ? br.refs.$brContainer[0] : e.currentTarget;\n    const is1UpMode = br.constMode1up === br.mode;\n    const validBookClick = is1UpMode || isCenterClick(e, book);\n    const isValidClickArea = atBookCenter ? validBookClick : isBackground(e.target);\n    if (isValidClickArea) {\n      toggleNav(br, atBookCenter);\n\n      if (atBookCenter) {\n        e.stopPropagation(); // don't turn the page. this takes prescendence\n      }\n    }\n  }\n\n  /**\n     * background click event handler\n     * @param { object } br - BookReader instance\n     * @param { MouseEvent } e - JS event object\n     */\n  function onBackgroundClick(br, e) {\n    toggleRouter(br, e);\n  }\n\n  /**\n     * actual book container click event handler\n     *\n     * @param { object } br - BookReader instance\n     * @param { MouseEvent } e - JS event object\n     */\n  function onBookClick(br, e) {\n\n    const atBookCenter = true;\n    toggleRouter(br, e, atBookCenter);\n  }\n\n  let initialX;\n  let initialY;\n  /**\n     * attaches mouseup & mousedown event handlers to assess if user is dragging\n     * sets `initialX`, `initialY`, and `holdOffOnToggle`\n     */\n  function registerDragHandlers() {\n    const background = document.querySelector('.BookReader');\n    if (!background) {\n      return;\n    }\n\n    background.addEventListener('mousedown', function (e) {\n      initialX = e.screenX;\n      initialY = e.screenY;\n\n      holdOffOnToggle = true;\n    }, true);\n    background.addEventListener('mouseup', function (e) {\n      const isDrag = (Math.abs(initialX - e.screenX) > 5 || Math.abs(initialY - e.screenY) > 5);\n\n      if (!isDrag) {\n        holdOffOnToggle = false;\n        initialX = 0;\n        initialY = 0;\n      }\n    }, true);\n  }\n\n  /**\n     * attaches click handlers to background & book\n     * @param { object } br - BookReader instance\n     */\n  function registerClickHandlers(br) {\n    const background = document.querySelector('.BookReader');\n    if (!background) {\n      return;\n    }\n\n    background.addEventListener('click', onBackgroundClick.bind(null, br), { capture: true, passive: true });\n\n    const desk = document.querySelector('.BRcontainer') || {};\n    const book = desk.firstChild;\n\n    if (book) {\n      book.addEventListener('click', onBookClick.bind(null, br), true);\n      registerDragHandlers();\n    }\n  }\n\n  /**\n     * Install menu toggle\n     * attaches event handlers, sets up DOM on load\n     */\n  const installMenuToggle = function installMenuToggle(br) {\n    let hasNav = false;\n\n    try {\n      hasNav = br.navigationIsVisible();\n    } catch (error) {\n      hasNav = false;\n    }\n\n    if (!hasNav) {\n      return;\n    }\n\n    const menuToggleEventRegister = function menuToggleEventRegister(e) {\n      registerClickHandlers(br);\n    };\n\n    const setupDOMandHandlers = function setupDOMandHandlers(e) {\n      setupNavForToggle(br);\n    };\n\n    const persistNav = function persistNav(e) {\n      alwaysShowNav(br);\n    };\n\n    const whenToToggleNav = [\n      'BookReader:1PageViewSelected',\n      'BookReader:2PageViewSelected',\n      'BookReader:zoomIn',\n      'BookReader:zoomOut',\n      'BookReader:resize'\n    ];\n\n    const whenTolwaysShowNavWhen = [\n      'BookReader:3PageViewSelected'\n    ];\n\n    $(document).on(whenTolwaysShowNavWhen.join(' '), persistNav);\n    $(document).on(whenToToggleNav.join(' '), menuToggleEventRegister);\n    $(window).on('orientationchange', menuToggleEventRegister);\n    $(document).on('BookReader:fullscreenToggled', setupDOMandHandlers);\n    $(window).on('DOMContentLoaded', setupDOMandHandlers);\n    setupDOMandHandlers();\n  };\n\n  /**\n     * Add to BookReader\n     */\n  BookReader.prototype.setup = (function(super_) {\n    return function(options) {\n      super_.call(this, options);\n    };\n  })(BookReader.prototype.setup);\n\n  /**\n     * Initialize plugin\n     */\n  BookReader.prototype.init = (function(super_) {\n    return function() {\n      super_.call(this);\n      if (this.options.enableMenuToggle) {\n        installMenuToggle(this);\n      }\n    };\n  })(BookReader.prototype.init);\n})();\n"],"sourceRoot":""}