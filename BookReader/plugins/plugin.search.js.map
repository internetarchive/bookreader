{"version":3,"sources":["webpack://@internetarchive/bookreader/./src/plugins/search/plugin.search.js","webpack://@internetarchive/bookreader/./src/plugins/search/view.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/inherit-if-required.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.object.assign.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.object.entries.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.regexp.constructor.js"],"names":["super_","br","searchCancelledCallback","this","matcher","RegExp","matches","cacheDOMElements","bindEvents","cancelSearch","dom","toolbarSearch","buildToolbarSearch","query","$","val","remove","dispatchEventWhenComplete","removeSearchResults","removeResultPins","emptyMatches","setQuery","teardownSearchNavigation","trigger","selector","before","resultsPosition","searchNavigation","positionMessage","length","currentMatchIndex","namespace","on","clearSearchFieldAndResults","bind","showPrevResult","showNextResult","toggleSidebar","mode","constModeThumb","switchMode","constMode1up","getClosestMatchIndex","start","end","comparator","eq","click","updateResultsPosition","updateSearchNavigationButtons","comparisonFn","closestPage","closestTo","pool","slice","map","m","par","page","currentIndex","indexOf","find","text","attr","off","resize","matchingSearchResult","constMode2up","find2upMatchingSearchResult","find1upMatchingSearchResult","_isIndexDisplayed","setCurrentMatchIndex","bool","pinsVisibleState","refs","$BRfooter","css","visibility","document","createElement","classList","add","innerHTML","imagesBaseURL","forEach","match","queryString","pageIndex","leafNumToIndex","pageNumber","getPageNum","percentThrough","constructor","util","cssPercentage","getNumLeafs","queryStringWithB","replace","queryStringWithBTruncated","addClass","left","append","data","appendTo","hover","event","marker","currentTarget","tooltip","querySelector","tooltipOffset","getBoundingClientRect","targetOffset","boxSizeAdjust","parseInt","getComputedStyle","paddingLeft","x","style","setProperty","removeClass","target","_searchPluginGoToResult","showProgressPopup","progressPopupClosed","removeProgressPopup","toggleSearchPending","textIsProcessing","errorDetails","renderModalMessage","delayModalRemovalFor","messageHTML","modal","el","timeoutMS","setTimeout","e","preventDefault","value","search","results","options","renderSearchNavigation","bindSearchNavigationEvents","renderPins","goToFirstResult","one","is_visible","navigationIsVisible","togglePinsFor","removeSearchHilites","searchTerm","isIndexed","detail","props","indexed","renderErrorModal","renderBookNotIndexedModal","renderResultsEmptyModal","window","addEventListener","handleSearchCallbackError","handleSearchCallback","handleNavToggledCallback","handleSearchStarted","handleSearchCallbackBookNotIndexed","handleSearchCallbackEmpty","updateSearchNavigation","submitHandler","jQuery","extend","BookReader","defaultOptions","server","bookId","subPrefix","bookPath","enableSearch","searchInsideUrl","initialSearchTerm","prototype","setup","call","searchResults","searchXHR","_cancelSearch","cancelSearchRequest","_searchBoxesByIndex","searchView","SearchView","term","instance","init","suppressFragmentChange","buildToolbarElement","$el","after","_createPageContainer","index","pageContainer","renderBoxesInPageContainerLayer","$container","overrides","disablePopup","error","success","eventNames","fragmentChange","serverPath","baseUrl","path","subPrefixWithSlash","lastIndexOf","substr","urlParams","item_id","doc","q","paramStr","param","url","cleanup","BRSearchInProgress","processSearchResults","searchInsideResults","responseHasError","hasCustomError","hasCustomSuccess","BRSearchCallbackError","BRSearchCallback","beforeSend","xhr","ajax","dataType","jsonpCallback","then","abort","updateSearchHilites","_models","book","_BRSearchCallbackError","basePayload","payload","Object","assign","boxesByIndex","boxes","box","push","pageIndexString","parseFloat","getPage","getActivePageContainerElementsForIndex","container","entries","getActivePageContainerElements","makeUnviewableAtEnd","isViewable","fetch","URLSearchParams","id","subprefix","leafNum","r","json","resp","makeViewable","jumpToIndex","searchHighlightVisible","visiblePages","twoPage","currentIndexL","currentIndexR","some","inArray","isObject","setPrototypeOf","module","exports","$this","dummy","Wrapper","NewTarget","NewTargetPrototype","stat","forced","$entries","O","DESCRIPTORS","global","isForced","inheritIfRequired","defineProperty","getOwnPropertyNames","isRegExp","getFlags","stickyHelpers","redefine","fails","enforceInternalState","setSpecies","MATCH","wellKnownSymbol","NativeRegExp","RegExpPrototype","re1","re2","CORRECT_NEW","UNSUPPORTED_Y","RegExpWrapper","pattern","flags","sticky","thisIsRegExp","patternIsRegExp","flagsAreUndefined","undefined","source","result","proxy","key","configurable","get","set","it","keys"],"mappings":"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","file":"plugins/plugin.search.js","sourcesContent":["/* global BookReader */\n/**\n * Plugin for Archive.org book search\n * NOTE: This script must be loaded AFTER `plugin.mobile_nav.js`\n * as it mutates mobile nav drawer\n *\n * Events fired at various points throughout search processing are published\n * on the document DOM element. These can be subscribed to using jQuery's event\n * binding method `$.fn.on`. All of the events are prefixed with a BookReader\n * namespace. The events are:\n *\n * @event BookReader:SearchStarted - When a search form is submitted, immediately\n *   before an AJAX call is made to request search results\n * @event BookReader:SearchCallback - When the search AJAX call is returned and at\n *   least one result is returned. The event callback receives an object\n *   with the `results`, plugin `options`, and the BookReader `instance`\n * @event BookReader:SearchCallbackError - When the AJAX request returns an error.\n *   Receives the `results` and `instance`\n * @event BookReader:SearchCallbackNotIndexed - When a message is received that\n *   the book has not had OCR text indexed yet. Receives `instance`\n * @event BookReader:SearchCallbackEmpty - When no results found. Receives\n *   `instance`\n * @event BookReader:SearchCanceled - When no results found. Receives\n *   `instance`\n */\nimport { renderBoxesInPageContainerLayer } from '../../BookReader/PageContainer.js';\nimport SearchView from './view.js';\n/** @typedef {import('../../BookReader/PageContainer').PageContainer} PageContainer */\n/** @typedef {import('../../BookReader/BookModel').PageIndex} PageIndex */\n\njQuery.extend(BookReader.defaultOptions, {\n  server: 'ia600609.us.archive.org',\n  bookId: '',\n  subPrefix: '',\n  bookPath: '',\n  enableSearch: true,\n  searchInsideUrl: '/fulltext/inside.php',\n  initialSearchTerm: null,\n});\n\n/** @override */\nBookReader.prototype.setup = (function (super_) {\n  return function (options) {\n    super_.call(this, options);\n\n    this.searchTerm = '';\n    this.searchResults = null;\n    this.searchInsideUrl = options.searchInsideUrl;\n    this.enableSearch = options.enableSearch;\n\n    // Base server used by some api calls\n    this.bookId = options.bookId;\n    this.server = options.server;\n    this.subPrefix = options.subPrefix;\n    this.bookPath = options.bookPath;\n\n    this.searchXHR = null;\n    this._cancelSearch.bind(this);\n    this.cancelSearchRequest.bind(this);\n\n    /** @type { {[pageIndex: number]: SearchInsideMatchBox[]} } */\n    this._searchBoxesByIndex = {};\n\n    if (this.searchView) { return; }\n    this.searchView = new SearchView({\n      br: this,\n      searchCancelledCallback: () => {\n        this._cancelSearch();\n        this.trigger('SearchCanceled', { term: this.searchTerm, instance: this });\n      }\n    });\n  };\n})(BookReader.prototype.setup);\n\n/** @override */\nBookReader.prototype.init = (function (super_) {\n  return function () {\n    super_.call(this);\n\n    if (this.options.enableSearch && this.options.initialSearchTerm) {\n      /**\n       * this.search() take two parameter\n       * 1. this.options.initialSearchTerm - search term\n       * 2. {\n       *  goToFirstResult: this.options.goToFirstResult,\n       *  suppressFragmentChange: false // always want to change fragment in URL\n       * }\n       */\n      this.search(\n        this.options.initialSearchTerm,\n        { goToFirstResult: this.options.goToFirstResult, suppressFragmentChange: false }\n      );\n    }\n  };\n})(BookReader.prototype.init);\n\n/** @override */\nBookReader.prototype.buildToolbarElement = (function (super_) {\n  return function () {\n    const $el = super_.call(this);\n    if (!this.enableSearch) { return; }\n    if (this.searchView.dom.toolbarSearch) {\n      $el.find('.BRtoolbarSectionInfo').after(this.searchView.dom.toolbarSearch);\n    }\n    return $el;\n  };\n})(BookReader.prototype.buildToolbarElement);\n\n/** @override */\nBookReader.prototype._createPageContainer = (function (super_) {\n  return function (index) {\n    const pageContainer = super_.call(this, index);\n    if (this.enableSearch && pageContainer.page && index in this._searchBoxesByIndex) {\n      const pageIndex = pageContainer.page.index;\n      renderBoxesInPageContainerLayer('searchHiliteLayer', this._searchBoxesByIndex[pageIndex], pageContainer.page, pageContainer.$container[0]);\n    }\n    return pageContainer;\n  };\n})(BookReader.prototype._createPageContainer);\n\n/**\n * @typedef {object} SearchOptions\n * @property {boolean} goToFirstResult\n * @property {boolean} disablePopup\n * @property {(null|function)} error - @deprecated at v.5.0\n * @property {(null|function)} success - @deprecated at v.5.0\n */\n\n/**\n * Submits search request\n *\n * @param {string} term\n * @param {SearchOptions} overrides\n */\nBookReader.prototype.search = function(term = '', overrides = {}) {\n  /** @type {SearchOptions} */\n  const defaultOptions = {\n    goToFirstResult: false, /* jump to the first result (default=false) */\n    disablePopup: false,    /* don't show the modal progress (default=false) */\n    suppressFragmentChange: false, /* don't change the URL on initial load */\n    error: null,            /* optional error handler (default=null) */\n    success: null,          /* optional success handler (default=null) */\n\n  };\n  const options = jQuery.extend({}, defaultOptions, overrides);\n  this.suppressFragmentChange = options.suppressFragmentChange;\n\n  // strip slashes, since this goes in the url\n  this.searchTerm = term.replace(/\\//g, ' ');\n\n  if (!options.suppressFragmentChange) {\n    this.trigger(BookReader.eventNames.fragmentChange);\n  }\n\n  // Add quotes to the term. This is to compenstate for the backends default OR query\n  // term = term.replace(/['\"]+/g, '');\n  // term = '\"' + term + '\"';\n\n  // Remove the port and userdir\n  const serverPath = this.server.replace(/:.+/, '');\n  const baseUrl = `https://${serverPath}${this.searchInsideUrl}?`;\n\n  // Remove subPrefix from end of path\n  let path = this.bookPath;\n  const subPrefixWithSlash = `/${this.subPrefix}`;\n  if (this.bookPath.length - this.bookPath.lastIndexOf(subPrefixWithSlash) == subPrefixWithSlash.length) {\n    path = this.bookPath.substr(0, this.bookPath.length - subPrefixWithSlash.length);\n  }\n\n  const urlParams = {\n    item_id: this.bookId,\n    doc: this.subPrefix,\n    path,\n    q: term,\n  };\n\n  // NOTE that the API does not expect / (slashes) to be encoded. (%2F) won't work\n  const paramStr = $.param(urlParams).replace(/%2F/g, '/');\n\n  const url = `${baseUrl}${paramStr}`;\n\n  const cleanup = () => {\n    this.searchXHR = null;\n    window.BRSearchInProgress = () => {};\n  };\n\n  const processSearchResults = (searchInsideResults) => {\n    if (!this.searchXHR) {\n      return;\n    }\n    const responseHasError = searchInsideResults.error || !searchInsideResults.matches.length;\n    const hasCustomError = typeof options.error === 'function';\n    const hasCustomSuccess = typeof options.success === 'function';\n\n    if (responseHasError) {\n      hasCustomError\n        ? options.error.call(this, searchInsideResults, options)\n        : this.BRSearchCallbackError(searchInsideResults, options);\n    } else {\n      hasCustomSuccess\n        ? options.success.call(this, searchInsideResults, options)\n        : this.BRSearchCallback(searchInsideResults, options);\n    }\n    cleanup();\n  };\n\n  const beforeSend = (xhr) => {\n    this.searchXHR = xhr;\n    window.BRSearchInProgress = processSearchResults;\n  };\n\n  this.trigger('SearchStarted', { term: this.searchTerm, instance: this });\n  return $.ajax({\n    url: url,\n    dataType: 'jsonp',\n    beforeSend,\n    jsonpCallback: 'BRSearchInProgress'\n  }).then(processSearchResults);\n};\n\n/**\n * cancels AJAX Call\n * emits custom event\n */\nBookReader.prototype._cancelSearch = function () {\n  this.searchXHR?.abort();\n  this.searchView.clearSearchFieldAndResults(false);\n  this.searchTerm = '';\n  this.searchXHR = null;\n  this.searchResults = [];\n  window.BRSearchInProgress = () => {};\n};\n\n/**\n * External function to cancel search\n * checks for term & xhr in flight before running\n */\nBookReader.prototype.cancelSearchRequest = function () {\n  if (this.searchXHR !== null) {\n    this._cancelSearch();\n    this.searchView.toggleSearchPending();\n    this.trigger('SearchCanceled', { term: this.searchTerm, instance: this });\n  }\n};\n\n/**\n  * @typedef {object} SearchInsideMatchBox\n  * @property {number} page\n  * @property {number} r\n  * @property {number} l\n  * @property {number} b\n  * @property {number} t\n  * @property {HTMLDivElement} [div]\n  */\n\n/**\n * @typedef {object} SearchInsideMatch\n * @property {string} text\n * @property {Array<{ page: number, boxes: SearchInsideMatchBox[] }>} par\n */\n\n/**\n * @typedef {object} SearchInsideResults\n * @property {string} error\n * @property {SearchInsideMatch[]} matches\n * @property {boolean} indexed\n */\n\n/**\n * Search Results return handler\n * @callback\n * @param {SearchInsideResults} results\n * @param {object} options\n * @param {boolean} options.goToFirstResult\n */\nBookReader.prototype.BRSearchCallback = function(results, options) {\n  this.searchResults = results || [];\n\n  this.updateSearchHilites();\n  this.removeProgressPopup();\n  if (options.goToFirstResult) {\n    const pageIndex = this._models.book.leafNumToIndex(results.matches[0].par[0].page);\n    this._searchPluginGoToResult(pageIndex);\n  }\n  this.trigger('SearchCallback', { results, options, instance: this });\n};\n\n/**\n * Main search results error handler\n * @callback\n * @param {SearchInsideResults} results\n */\nBookReader.prototype.BRSearchCallbackError = function(results) {\n  this._BRSearchCallbackError(results);\n};\n\n/**\n * @private draws search results error\n * @callback\n * @param {SearchInsideResults} results\n * @param {jQuery} $el\n * @param {boolean} fade\n */\nBookReader.prototype._BRSearchCallbackError = function(results) {\n  this.searchResults = results;\n  const basePayload = {\n    term: this.searchTerm,\n    instance: this,\n  };\n  if (results.error) {\n    const payload = Object.assign({}, basePayload, { results });\n    this.trigger('SearchCallbackError', payload);\n  } else if (0 == results.matches.length) {\n    if (false === results.indexed) {\n      this.trigger('SearchCallbackBookNotIndexed', basePayload);\n      return;\n    }\n    this.trigger('SearchCallbackEmpty', basePayload);\n  }\n};\n\n/**\n * updates search on-page highlights controller\n */\nBookReader.prototype.updateSearchHilites = function() {\n  /** @type {SearchInsideMatch[]} */\n  const matches = this.searchResults?.matches || [];\n  /** @type { {[pageIndex: number]: SearchInsideMatch[]} } */\n  const boxesByIndex = {};\n\n  // Clear any existing svg layers\n  this.removeSearchHilites();\n\n  // Group by pageIndex\n  for (const match of matches) {\n    for (const box of match.par[0].boxes) {\n      const pageIndex = this.leafNumToIndex(box.page);\n      const pageMatches = boxesByIndex[pageIndex] || (boxesByIndex[pageIndex] = []);\n      pageMatches.push(box);\n    }\n  }\n\n  // update any already created pages\n  for (const [pageIndexString, boxes] of Object.entries(boxesByIndex)) {\n    const pageIndex = parseFloat(pageIndexString);\n    const page = this._models.book.getPage(pageIndex);\n    const pageContainers = this.getActivePageContainerElementsForIndex(pageIndex);\n    pageContainers.forEach(container => renderBoxesInPageContainerLayer('searchHiliteLayer', boxes, page, container));\n  }\n\n  this._searchBoxesByIndex = boxesByIndex;\n};\n\n/**\n * remove search highlights\n */\nBookReader.prototype.removeSearchHilites = function() {\n  $(this.getActivePageContainerElements()).find('.searchHiliteLayer').remove();\n};\n\n/**\n * @private\n * Goes to the page specified. If the page is not viewable, tries to load the page\n * FIXME Most of this logic is IA specific, and should be less integrated into here\n * or at least more configurable.\n * @param {PageIndex} pageIndex\n */\nBookReader.prototype._searchPluginGoToResult = async function (pageIndex) {\n  const { book } = this._models;\n  const page = book.getPage(pageIndex);\n  let makeUnviewableAtEnd = false;\n  if (!page.isViewable) {\n    const resp = await fetch('/services/bookreader/request_page?' + new URLSearchParams({\n      id: this.options.bookId,\n      subprefix: this.options.subPrefix,\n      leafNum: page.leafNum,\n    })).then(r => r.json());\n\n    for (const leafNum of resp.value) {\n      book.getPage(book.leafNumToIndex(leafNum)).makeViewable();\n    }\n\n    // not able to show page; make the page viewable anyways so that it can\n    // actually open. On IA, it has a fallback to a special error page.\n    if (!resp.value.length) {\n      book.getPage(pageIndex).makeViewable();\n      makeUnviewableAtEnd = true;\n    }\n  }\n  /* this updates the URL */\n  this.suppressFragmentChange = false;\n  this.jumpToIndex(pageIndex);\n\n  // Reset it to unviewable if it wasn't resolved\n  if (makeUnviewableAtEnd) {\n    book.getPage(pageIndex).makeViewable(false);\n  }\n};\n\n/**\n * Removes all search pins\n */\nBookReader.prototype.removeSearchResults = function(suppressFragmentChange = false) {\n  this.removeSearchHilites(); //be sure to set all box.divs to null\n  this.searchTerm = null;\n  this.searchResults = null;\n  if (!suppressFragmentChange) {\n    this.trigger(BookReader.eventNames.fragmentChange);\n  }\n};\n\n/**\n * Returns true if a search highlight is currently being displayed\n * @returns {boolean}\n */\nBookReader.prototype.searchHighlightVisible = function() {\n  const results = this.searchResults;\n  let visiblePages = [];\n  if (null == results) return false;\n\n  if (this.constMode2up == this.mode) {\n    visiblePages = [this.twoPage.currentIndexL, this.twoPage.currentIndexR];\n  } else if (this.constMode1up == this.mode) {\n    visiblePages = [this.currentIndex()];\n  } else {\n    return false;\n  }\n\n  results.matches.some(match => {\n    return match.par[0].boxes.some(box => {\n      const pageIndex = this.leafNumToIndex(box.page);\n      if (jQuery.inArray(pageIndex, visiblePages) >= 0) {\n        return true;\n      }\n    });\n  });\n\n  return false;\n};\n","class SearchView {\n  /**\n   * @param {object} params\n   * @param {object} params.br The BookReader instance\n   * @param {function} params.cancelSearch callback when a user wants to cancel search\n   *\n   * @event BookReader:SearchResultsCleared - when the search results nav gets cleared\n   * @event BookReader:ToggleSearchMenu - when search results menu should toggle\n   */\n  constructor({ br, searchCancelledCallback = () => {} }) {\n    this.br = br;\n\n    // Search results are returned as a text blob with the hits wrapped in\n    // triple mustaches. Hits occasionally include text beyond the search\n    // term, so everything within the staches is captured and wrapped.\n    this.matcher = new RegExp('{{{(.+?)}}}', 'g');\n    this.matches = [];\n    this.cacheDOMElements();\n    this.bindEvents();\n    this.cancelSearch = searchCancelledCallback;\n  }\n\n  cacheDOMElements() {\n    this.dom = {};\n    // Search input within the top toolbar. Will be removed once the mobile menu is replaced.\n    this.dom.toolbarSearch = this.buildToolbarSearch();\n  }\n\n  /**\n   * @param {string} query\n   */\n  setQuery(query) {\n    this.br.$('[name=\"query\"]').val(query);\n  }\n\n  emptyMatches() {\n    this.matches = [];\n  }\n\n  removeResultPins() {\n    this.br.$('.BRnavpos .BRsearch').remove();\n  }\n\n  clearSearchFieldAndResults(dispatchEventWhenComplete = true) {\n    this.br.removeSearchResults();\n    this.removeResultPins();\n    this.emptyMatches();\n    this.setQuery('');\n    this.teardownSearchNavigation();\n    if (dispatchEventWhenComplete) {\n      this.br.trigger('SearchResultsCleared');\n    }\n  }\n\n  toggleSidebar() {\n    this.br.trigger('ToggleSearchMenu');\n  }\n\n  renderSearchNavigation() {\n    const selector = 'BRsearch-navigation';\n    $('.BRnav').before(`\n      <div class=\"${selector}\">\n        <button class=\"toggle-sidebar\">\n          <h4>\n            <span class=\"icon icon-search\"></span> Results\n          </h4>\n        </button>\n        <div class=\"pagination\">\n          <button class=\"prev\" title=\"Previous result\"><span class=\"icon icon-chevron hflip\"></span></button>\n          <span data-id=\"resultsCount\">${this.resultsPosition()}</span>\n          <button class=\"next\" title=\"Next result\"><span class=\"icon icon-chevron\"></button>\n        </div>\n        <button class=\"clear\" title=\"Clear search results\">\n          <span class=\"icon icon-close\"></span>\n        </button>\n      </div>\n    `);\n    this.dom.searchNavigation = $(`.${selector}`);\n  }\n\n  resultsPosition() {\n    let positionMessage = `${this.matches.length} result${this.matches.length === 1 ? '' : 's'}`;\n    if (~this.currentMatchIndex) {\n      positionMessage = `${this.currentMatchIndex + 1} / ${this.matches.length}`;\n    }\n    return positionMessage;\n  }\n\n  bindSearchNavigationEvents() {\n    if (!this.dom.searchNavigation) { return; }\n    const namespace = 'searchNavigation';\n\n    this.dom.searchNavigation\n      .on(`click.${namespace}`, '.clear', this.clearSearchFieldAndResults.bind(this))\n      .on(`click.${namespace}`, '.prev', this.showPrevResult.bind(this))\n      .on(`click.${namespace}`, '.next', this.showNextResult.bind(this))\n      .on(`click.${namespace}`, '.toggle-sidebar', this.toggleSidebar.bind(this))\n      .on(`click.${namespace}`, false);\n  }\n\n  showPrevResult() {\n    if (this.currentMatchIndex === 0) { return; }\n    if (this.br.mode === this.br.constModeThumb) { this.br.switchMode(this.br.constMode1up); }\n    if (!~this.currentMatchIndex) {\n      this.currentMatchIndex = this.getClosestMatchIndex((start, end, comparator) => end[0] > comparator) + 1;\n    }\n    this.br.$('.BRnavline .BRsearch').eq(--this.currentMatchIndex).click();\n    this.updateResultsPosition();\n    this.updateSearchNavigationButtons();\n  }\n\n  showNextResult() {\n    if (this.currentMatchIndex + 1 === this.matches.length) { return; }\n    if (this.br.mode === this.br.constModeThumb) { this.br.switchMode(this.br.constMode1up); }\n    if (!~this.currentMatchIndex) {\n      this.currentMatchIndex = this.getClosestMatchIndex((start, end, comparator) => start[start.length - 1] > comparator) - 1;\n    }\n    this.br.$('.BRnavline .BRsearch').eq(++this.currentMatchIndex).click();\n    this.updateResultsPosition();\n    this.updateSearchNavigationButtons();\n  }\n\n  /**\n   * Obtains closest match based on the logical comparison function passed in.\n   * When the comparison function returns true, the starting (left) half of the\n   * matches array is used in the binary split, else the ending (right) half is\n   * used. A recursive call is made to perform the same split and comparison\n   * on the winning half of the matches. This is traditionally known as binary\n   * search (https://en.wikipedia.org/wiki/Binary_search_algorithm), and in\n   * most cases (medium to large search result arrays) should outperform\n   * traversing the array from start to finish. In the case of small arrays,\n   * the speed difference is negligible.\n   *\n   * @param {function} comparisonFn\n   * @return {number} matchIndex\n   */\n  getClosestMatchIndex(comparisonFn) {\n    const matchPages = this.matches.map((m) => m.par[0].page);\n    const currentPage = this.br.currentIndex() + 1;\n    const closestTo = (pool, comparator) => {\n      if (pool.length === 1) { return pool[0]; }\n      const start = pool.slice(0, pool.length / 2);\n      const end = pool.slice(pool.length / 2);\n      return closestTo((comparisonFn(start, end, comparator) ? start : end), comparator);\n    };\n\n    const closestPage = closestTo(matchPages, currentPage);\n    return this.matches.indexOf(this.matches.find((m) => m.par[0].page === closestPage));\n  }\n\n  updateResultsPosition() {\n    this.dom.searchNavigation.find('[data-id=resultsCount]').text(this.resultsPosition());\n  }\n\n  updateSearchNavigationButtons() {\n    this.dom.searchNavigation.find('.prev').attr('disabled', !this.currentMatchIndex);\n    this.dom.searchNavigation.find('.next').attr('disabled', this.currentMatchIndex + 1 === this.matches.length);\n  }\n\n  teardownSearchNavigation() {\n    if (!this.dom.searchNavigation) {\n      this.dom.searchNavigation = $('.BRsearch-navigation');\n    }\n    if (!this.dom.searchNavigation.length) { return; }\n\n    this.dom.searchNavigation.off('.searchNavigation').remove();\n    this.dom.searchNavigation = null;\n    this.br.resize();\n  }\n\n  setCurrentMatchIndex() {\n    let matchingSearchResult;\n    if (this.br.mode === this.br.constModeThumb) {\n      this.currentMatchIndex = -1;\n      return;\n    }\n    if (this.br.mode === this.br.constMode2up) {\n      matchingSearchResult = this.find2upMatchingSearchResult();\n    }\n    else {\n      matchingSearchResult = this.find1upMatchingSearchResult();\n    }\n    this.currentMatchIndex = this.matches.indexOf(matchingSearchResult);\n  }\n\n  find1upMatchingSearchResult() {\n    return this.matches.find((m) => this.br.currentIndex() === m.par[0].page - 1);\n  }\n\n  find2upMatchingSearchResult() {\n    return this.matches.find((m) => this.br._isIndexDisplayed(m.par[0].page - 1));\n  }\n\n  updateSearchNavigation() {\n    if (!this.matches.length) { return; }\n\n    this.setCurrentMatchIndex();\n    this.updateResultsPosition();\n    this.updateSearchNavigationButtons();\n  }\n\n  /**\n   * @param {boolean} bool\n   */\n  togglePinsFor(bool) {\n    const pinsVisibleState = bool ? 'visible' : 'hidden';\n    this.br.refs.$BRfooter.find('.BRsearch').css({ visibility: pinsVisibleState });\n  }\n\n  buildToolbarSearch() {\n    const toolbarSearch = document.createElement('span');\n    toolbarSearch.classList.add('BRtoolbarSection', 'BRtoolbarSectionSearch');\n    toolbarSearch.innerHTML = `\n      <form class=\"BRbooksearch desktop\">\n        <input type=\"search\" name=\"query\" class=\"BRsearchInput\" value=\"\" placeholder=\"Search inside\"/>\n        <button type=\"submit\" class=\"BRsearchSubmit\">\n          <img src=\"${this.br.imagesBaseURL}icon_search_button.svg\" />\n        </button>\n      </form>\n    `;\n    return toolbarSearch;\n  }\n\n  /**\n   * @param {array} matches\n   */\n  renderPins(matches) {\n    matches.forEach((match) => {\n      const queryString = match.text;\n      const pageIndex = this.br.leafNumToIndex(match.par[0].page);\n      const pageNumber = this.br.getPageNum(pageIndex);\n      const uiStringSearch = \"Search result\"; // i18n\n      const uiStringPage = \"Page\"; // i18n\n\n      const percentThrough = this.br.constructor.util.cssPercentage(pageIndex, this.br.getNumLeafs() - 1);\n\n      const queryStringWithB = queryString.replace(this.matcher, '<b>$1</b>');\n\n      let queryStringWithBTruncated = '';\n\n      if (queryString.length > 100) {\n        queryStringWithBTruncated = queryString\n          .replace(/^(.{100}[^\\s]*).*/, \"$1\")\n          .replace(this.matcher, '<b>$1</b>')\n                + '...';\n      }\n\n      // draw marker\n      $('<div>')\n        .addClass('BRsearch')\n        .css({\n          left: percentThrough,\n        })\n        .attr('title', uiStringSearch)\n        .append(`\n          <div class=\"BRquery\">\n            <div>${queryStringWithBTruncated || queryStringWithB}</div>\n            <div>${uiStringPage} ${pageNumber}</div>\n          </div>\n        `)\n        .data({ pageIndex })\n        .appendTo(this.br.$('.BRnavline'))\n        .hover(\n          (event) => {\n            // remove from other markers then turn on just for this\n            // XXX should be done when nav slider moves\n            const marker = event.currentTarget;\n            const tooltip = marker.querySelector('.BRquery');\n            const tooltipOffset = tooltip.getBoundingClientRect();\n            const targetOffset = marker.getBoundingClientRect();\n            const boxSizeAdjust = parseInt(getComputedStyle(tooltip).paddingLeft) * 2;\n            if (tooltipOffset.x - boxSizeAdjust < 0) {\n              tooltip.style.setProperty('transform', `translateX(-${targetOffset.left - boxSizeAdjust}px)`);\n            }\n            $('.BRsearch,.BRchapter').removeClass('front');\n            $(event.target).addClass('front');\n          },\n          (event) => $(event.target).removeClass('front'))\n        .click(function (event) {\n          // closures are nested and deep, using an arrow function breaks references.\n          // Todo: update to arrow function & clean up closures\n          // to remove `bind` dependency\n          this.br._searchPluginGoToResult(+$(event.target).data('pageIndex'));\n        }.bind(this));\n    });\n  }\n\n  /**\n   * @param {boolean} bool\n   */\n  toggleSearchPending(bool) {\n    if (bool) {\n      this.br.showProgressPopup(\"Search results will appear below...\", () => this.progressPopupClosed());\n    }\n    else {\n      this.br.removeProgressPopup();\n    }\n  }\n\n  /**\n   * Primary callback when user cancels search popup\n   */\n  progressPopupClosed() {\n    this.toggleSearchPending();\n    this.cancelSearch();\n  }\n\n  renderErrorModal(textIsProcessing = false) {\n    const errorDetails = `${!textIsProcessing ? 'The text may still be processing. ' : ''}Please try again.`;\n    this.renderModalMessage(`\n      Sorry, there was an error with your search.\n      <br />\n      ${errorDetails}\n    `);\n    this.delayModalRemovalFor(4000);\n  }\n\n  renderBookNotIndexedModal() {\n    this.renderModalMessage(`\n      <p>\n         This book hasn't been indexed for searching yet.\n         We've just started indexing it, so search should be available soon.\n         <br />\n         Please try again later. Thanks!\n      </p>\n    `);\n    this.delayModalRemovalFor(5000);\n  }\n\n  renderResultsEmptyModal() {\n    this.renderModalMessage('No matches were found.');\n    this.delayModalRemovalFor(2000);\n  }\n\n  /**\n   * @param {string} messageHTML The innerHTML string used to popupate the modal contents\n   */\n  renderModalMessage(messageHTML) {\n    const modal = document.createElement('div');\n    modal.classList.add('BRprogresspopup', 'search_modal');\n    modal.innerHTML = messageHTML;\n    document.querySelector(this.br.el).append(modal);\n  }\n\n  /**\n   * @param {number} timeoutMS\n   */\n  delayModalRemovalFor(timeoutMS) {\n    setTimeout(this.br.removeProgressPopup.bind(this.br), timeoutMS);\n  }\n\n  /**\n   * @param {Event} e\n   */\n  submitHandler(e) {\n    e.preventDefault();\n    const query = e.target.querySelector('[name=\"query\"]').value;\n    if (!query.length) { return false; }\n    this.br.search(query);\n    this.emptyMatches();\n    this.toggleSearchPending(true);\n    return false;\n  }\n\n  /**\n   * @param {Event} e\n   * @param {object} properties\n   *   @param {object} properties.results\n   *   @param {object} properties.options\n   */\n  handleSearchCallback(e, { results, options }) {\n    this.matches = results.matches;\n    this.setCurrentMatchIndex();\n    this.teardownSearchNavigation();\n    this.renderSearchNavigation();\n    this.bindSearchNavigationEvents();\n    this.renderPins(results.matches);\n    this.toggleSearchPending(false);\n    if (options.goToFirstResult) {\n      $(document).one('BookReader:pageChanged', () => {\n        this.br.resize();\n      });\n    } else {\n      this.br.resize();\n    }\n  }\n\n  /**\n   * @param {Event} e\n   */\n  handleNavToggledCallback(e) {\n    const is_visible = this.br.navigationIsVisible();\n    this.togglePinsFor(is_visible);\n  }\n\n  handleSearchStarted() {\n    this.emptyMatches();\n    this.br.removeSearchHilites();\n    this.removeResultPins();\n    this.toggleSearchPending(true);\n    this.teardownSearchNavigation();\n    this.setQuery(this.br.searchTerm);\n  }\n\n  /**\n   * Event listener for: `BookReader:SearchCallbackError`\n   * @param {CustomEvent} event\n   */\n  handleSearchCallbackError(event = {}) {\n    this.toggleSearchPending(false);\n    const isIndexed = event?.detail?.props?.results?.indexed;\n    this.renderErrorModal(isIndexed);\n  }\n\n  handleSearchCallbackBookNotIndexed() {\n    this.toggleSearchPending(false);\n    this.renderBookNotIndexedModal();\n  }\n\n  handleSearchCallbackEmpty() {\n    this.toggleSearchPending(false);\n    this.renderResultsEmptyModal();\n  }\n\n  bindEvents() {\n    const namespace = 'BookReader:';\n\n    window.addEventListener(`${namespace}SearchCallbackError`, this.handleSearchCallbackError.bind(this));\n    $(document).on(`${namespace}SearchCallback`, this.handleSearchCallback.bind(this))\n      .on(`${namespace}navToggled`, this.handleNavToggledCallback.bind(this))\n      .on(`${namespace}SearchStarted`, this.handleSearchStarted.bind(this))\n      .on(`${namespace}SearchCallbackBookNotIndexed`, this.handleSearchCallbackBookNotIndexed.bind(this))\n      .on(`${namespace}SearchCallbackEmpty`, this.handleSearchCallbackEmpty.bind(this))\n      .on(`${namespace}pageChanged`, this.updateSearchNavigation.bind(this));\n\n    this.dom.toolbarSearch.querySelector('form').addEventListener('submit', this.submitHandler.bind(this));\n  }\n}\n\nexport default SearchView;\n","var isObject = require('../internals/is-object');\nvar setPrototypeOf = require('../internals/object-set-prototype-of');\n\n// makes subclassing work correct for wrapped built-ins\nmodule.exports = function ($this, dummy, Wrapper) {\n  var NewTarget, NewTargetPrototype;\n  if (\n    // it can work only with native `setPrototypeOf`\n    setPrototypeOf &&\n    // we haven't completely correct pre-ES6 way for getting `new.target`, so use this\n    typeof (NewTarget = dummy.constructor) == 'function' &&\n    NewTarget !== Wrapper &&\n    isObject(NewTargetPrototype = NewTarget.prototype) &&\n    NewTargetPrototype !== Wrapper.prototype\n  ) setPrototypeOf($this, NewTargetPrototype);\n  return $this;\n};\n","var $ = require('../internals/export');\nvar assign = require('../internals/object-assign');\n\n// `Object.assign` method\n// https://tc39.es/ecma262/#sec-object.assign\n// eslint-disable-next-line es/no-object-assign -- required for testing\n$({ target: 'Object', stat: true, forced: Object.assign !== assign }, {\n  assign: assign\n});\n","var $ = require('../internals/export');\nvar $entries = require('../internals/object-to-array').entries;\n\n// `Object.entries` method\n// https://tc39.es/ecma262/#sec-object.entries\n$({ target: 'Object', stat: true }, {\n  entries: function entries(O) {\n    return $entries(O);\n  }\n});\n","var DESCRIPTORS = require('../internals/descriptors');\nvar global = require('../internals/global');\nvar isForced = require('../internals/is-forced');\nvar inheritIfRequired = require('../internals/inherit-if-required');\nvar defineProperty = require('../internals/object-define-property').f;\nvar getOwnPropertyNames = require('../internals/object-get-own-property-names').f;\nvar isRegExp = require('../internals/is-regexp');\nvar getFlags = require('../internals/regexp-flags');\nvar stickyHelpers = require('../internals/regexp-sticky-helpers');\nvar redefine = require('../internals/redefine');\nvar fails = require('../internals/fails');\nvar enforceInternalState = require('../internals/internal-state').enforce;\nvar setSpecies = require('../internals/set-species');\nvar wellKnownSymbol = require('../internals/well-known-symbol');\n\nvar MATCH = wellKnownSymbol('match');\nvar NativeRegExp = global.RegExp;\nvar RegExpPrototype = NativeRegExp.prototype;\nvar re1 = /a/g;\nvar re2 = /a/g;\n\n// \"new\" should create a new object, old webkit bug\nvar CORRECT_NEW = new NativeRegExp(re1) !== re1;\n\nvar UNSUPPORTED_Y = stickyHelpers.UNSUPPORTED_Y;\n\nvar FORCED = DESCRIPTORS && isForced('RegExp', (!CORRECT_NEW || UNSUPPORTED_Y || fails(function () {\n  re2[MATCH] = false;\n  // RegExp constructor can alter flags and IsRegExp works correct with @@match\n  return NativeRegExp(re1) != re1 || NativeRegExp(re2) == re2 || NativeRegExp(re1, 'i') != '/a/i';\n})));\n\n// `RegExp` constructor\n// https://tc39.es/ecma262/#sec-regexp-constructor\nif (FORCED) {\n  var RegExpWrapper = function RegExp(pattern, flags) {\n    var thisIsRegExp = this instanceof RegExpWrapper;\n    var patternIsRegExp = isRegExp(pattern);\n    var flagsAreUndefined = flags === undefined;\n    var sticky;\n\n    if (!thisIsRegExp && patternIsRegExp && pattern.constructor === RegExpWrapper && flagsAreUndefined) {\n      return pattern;\n    }\n\n    if (CORRECT_NEW) {\n      if (patternIsRegExp && !flagsAreUndefined) pattern = pattern.source;\n    } else if (pattern instanceof RegExpWrapper) {\n      if (flagsAreUndefined) flags = getFlags.call(pattern);\n      pattern = pattern.source;\n    }\n\n    if (UNSUPPORTED_Y) {\n      sticky = !!flags && flags.indexOf('y') > -1;\n      if (sticky) flags = flags.replace(/y/g, '');\n    }\n\n    var result = inheritIfRequired(\n      CORRECT_NEW ? new NativeRegExp(pattern, flags) : NativeRegExp(pattern, flags),\n      thisIsRegExp ? this : RegExpPrototype,\n      RegExpWrapper\n    );\n\n    if (UNSUPPORTED_Y && sticky) {\n      var state = enforceInternalState(result);\n      state.sticky = true;\n    }\n\n    return result;\n  };\n  var proxy = function (key) {\n    key in RegExpWrapper || defineProperty(RegExpWrapper, key, {\n      configurable: true,\n      get: function () { return NativeRegExp[key]; },\n      set: function (it) { NativeRegExp[key] = it; }\n    });\n  };\n  var keys = getOwnPropertyNames(NativeRegExp);\n  var index = 0;\n  while (keys.length > index) proxy(keys[index++]);\n  RegExpPrototype.constructor = RegExpWrapper;\n  RegExpWrapper.prototype = RegExpPrototype;\n  redefine(global, 'RegExp', RegExpWrapper);\n}\n\n// https://tc39.es/ecma262/#sec-get-regexp-@@species\nsetSpecies('RegExp');\n"],"sourceRoot":""}