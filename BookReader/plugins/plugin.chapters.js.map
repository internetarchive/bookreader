{"version":3,"file":"plugins/plugin.chapters.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/plugins/plugin.chapters.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.array.reverse.js"],"sourcesContent":["/* global BookReader */\n/**\n * Plugin for chapter markers in BookReader. Fetches from openlibrary.org\n * Could be forked, or extended to alter behavior\n */\n\njQuery.extend(BookReader.defaultOptions, {\n  olHost: 'https://openlibrary.org',\n  enableChaptersPlugin: true,\n  bookId: '',\n});\n\n/** @override Extend the constructor to add search properties */\nBookReader.prototype.setup = (function (super_) {\n  return function (options) {\n    super_.call(this, options);\n\n    this.olHost = options.olHost;\n    this.enableChaptersPlugin = options.enableChaptersPlugin;\n    this.bookId = options.bookId;\n  };\n})(BookReader.prototype.setup);\n\n/** @override Extend to call Open Library for TOC */\nBookReader.prototype.init = (function(super_) {\n  return function() {\n    super_.call(this);\n    if (this.enableChaptersPlugin && this.ui !== 'embed') {\n      this.getOpenLibraryRecord();\n    }\n    if (this.enableMobileNav) {\n      this.bind(BookReader.eventNames.mobileNavOpen,\n        () => {\n          this.updateTOCState(this.firstIndex, this._tocEntries);\n          if ($('table-contents-list').parent().hasClass('mm-opened')) {\n            this.updateTOCState(this.firstIndex, this._tocEntries);\n          }\n        }\n      );\n      $(\".BRmobileMenu__tableContents\").on(\"click\", () => {\n        this.updateTOCState(this.firstIndex, this._tocEntries);\n      });\n    }\n  };\n})(BookReader.prototype.init);\n\n/**\n * Adds chapter marker to navigation scrubber\n *\n * @param {string} chapterTitle\n * @param {string} pageNumber\n * @param {number} pageIndex\n */\nBookReader.prototype.addChapter = function(chapterTitle, pageNumber, pageIndex) {\n  const uiStringPage = 'Page'; // i18n\n  const percentThrough = BookReader.util.cssPercentage(pageIndex, this.getNumLeafs() - 1);\n  const jumpToChapter = (event) => {\n    this.jumpToIndex($(event.delegateTarget).data('pageIndex'));\n    $('.current-chapter').removeClass('current-chapter');\n    $(event.delegateTarget).addClass('current-chapter');\n  };\n  const title = `${chapterTitle} | `;\n  const pageStr = `${uiStringPage} ${pageNumber}`;\n\n  //adding items to mobile table of contents\n  const mobileChapter = $(`<li></li>`).append($(`<span class='BRTOCElementTitle'></span>`).text(title))\n    .append($(`<span class='BRTOCElementPage'></span>`).text(pageStr));\n  mobileChapter.addClass('BRtable-contents-el')\n    .appendTo(this.$('.table-contents-list'))\n    .data({ pageIndex });\n\n  //adds .BRchapters to the slider only if pageIndex exists\n  if (pageIndex != undefined) {\n    $(`<div></div>`)\n      .append($('<div />').text(title + pageStr))\n      .addClass('BRchapter')\n      .css({ left: percentThrough })\n      .appendTo(this.$('.BRnavline'))\n      .data({ pageIndex })\n      .on(\"mouseenter\", event => {\n        // remove hover effect from other markers then turn on just for this\n        const marker = event.currentTarget;\n        const tooltip = marker.querySelector('div');\n        const tooltipOffset = tooltip.getBoundingClientRect();\n        const targetOffset = marker.getBoundingClientRect();\n        const boxSizeAdjust = parseInt(getComputedStyle(tooltip).paddingLeft) * 2;\n        if (tooltipOffset.x - boxSizeAdjust < 0) {\n          tooltip.style.setProperty('transform', `translateX(-${targetOffset.left - boxSizeAdjust}px)`);\n        }\n        this.$('.BRsearch,.BRchapter').removeClass('front');\n        $(event.target).addClass('front');\n      })\n      .on(\"mouseleave\", event => $(event.target).removeClass('front'))\n      .on('click', jumpToChapter);\n\n    //adding clickable properties to mobile chapters\n    mobileChapter.bind('click', jumpToChapter)\n      .addClass('chapter-clickable')\n      .attr(\"data-event-click-tracking\",\"BRTOCPanel|GoToChapter\");\n  }\n\n};\n\n/*\n * Remove all chapters.\n */\nBookReader.prototype.removeChapters = function() {\n  this.$('.BRnavpos .BRchapter').remove();\n};\n\n/**\n * Update the table of contents based on array of TOC entries.\n * @param {TocEntry[]} tocEntries\n */\nBookReader.prototype.updateTOC = function(tocEntries) {\n  this.removeChapters();\n  if (this.enableMobileNav && tocEntries.length > 0) {\n    this.$(\".BRmobileMenu__tableContents\").show();\n  }\n  for (let i = 0; i < tocEntries.length; i++) {\n    this.addChapterFromEntry(tocEntries[i]);\n  }\n  this._tocEntries = tocEntries;\n  $('.table-contents-list').children().each((i, el) => {\n    tocEntries[i].mobileHTML = el;\n  });\n};\n\n/**\n * @typedef {Object} TocEntry\n * Table of contents entry as defined -- format is defined by Open Library\n * @property {string} pagenum\n * @property {number} level\n * @property {string} label\n * @property {{type: '/type/toc_item'}} type\n * @property {string} title\n * @property {HTMLElement} mobileHTML\n * @property {number} pageIndex\n\n *\n * @example {\n *   \"pagenum\": \"17\",\n *   \"level\": 1,\n *   \"label\": \"CHAPTER I\",\n *   \"type\": {\"key\": \"/type/toc_item\"},\n *   \"title\": \"THE COUNTRY AND THE MISSION\"\n * }\n */\n\n/**\n * @param {TocEntry} tocEntryObject\n */\nBookReader.prototype.addChapterFromEntry = function(tocEntryObject) {\n  tocEntryObject.pageIndex = this.getPageIndex(tocEntryObject['pagenum']);\n  //creates a string with non-void tocEntryObject.label and tocEntryObject.title\n  const chapterStr = [tocEntryObject.label, tocEntryObject.title]\n    .filter(x => x)\n    .join(' ');\n  this.addChapter(chapterStr, tocEntryObject['pagenum'], tocEntryObject.pageIndex);\n  this.$('.BRchapter, .BRsearch').each((i, el) => {\n    const $el = $(el);\n    $el\n      .on(\"mouseenter\", () => $el.addClass('front'))\n      .on(\"mouseleave\", () => $el.removeClass('front'));\n  });\n};\n\n/**\n * getOpenLibraryRecord\n *\n * The bookreader is designed to call openlibrary API and constructs the\n * \"Return book\" button using the response.\n *\n * This makes a call to OL API and calls the given callback function with the\n * response from the API.\n */\nBookReader.prototype.getOpenLibraryRecord = function () {\n  // Try looking up by ocaid first, then by source_record\n  const baseURL = `${this.olHost}/query.json?type=/type/edition&*=`;\n  const fetchUrlByBookId = `${baseURL}&ocaid=${this.bookId}`;\n\n  /*\n  * Update Chapter markers based on received record from Open Library.\n  * Notes that Open Library record is used for extra metadata, and also for lending\n  */\n  const setUpChapterMarkers = (olObject) => {\n    if (olObject && olObject.table_of_contents) {\n      // XXX check here that TOC is valid\n      this.updateTOC(olObject.table_of_contents);\n    }\n  };\n\n  $.ajax({ url: fetchUrlByBookId, dataType: 'jsonp' })\n    .then(data => {\n      if (data && data.length > 0) {\n        return data;\n      } else {\n      // try sourceid\n        return $.ajax({ url: `${baseURL}&source_records=ia:${this.bookId}`, dataType: 'jsonp' });\n      }\n    })\n    .then(data => {\n      if (data && data.length > 0) {\n        setUpChapterMarkers(data[0]);\n      }\n    });\n};\n\n// Extend buildMobileDrawerElement with table of contents list\nBookReader.prototype.buildMobileDrawerElement = (function (super_) {\n  return function () {\n    const $el = super_.call(this);\n    if (this.enableMobileNav && this.options.enableChaptersPlugin) {\n      $el.find('.BRmobileMenu__moreInfoRow').after($(`\n        <li class=\"BRmobileMenu__tableContents\" data-event-click-tracking=\"BRSidebar|TOCPanel\">\n            <span>\n                <span class=\"DrawerIconWrapper\">\n                  <img class=\"DrawerIcon\" src=\"${this.imagesBaseURL}icon_toc.svg\" alt=\"toc-icon\"/>\n                </span>\n                Table of Contents\n            </span>\n            <div>\n                <ol class=\"table-contents-list\">\n                </ol>\n            </div>\n        </li>`).hide());\n    }\n    return $el;\n  };\n})(BookReader.prototype.buildMobileDrawerElement);\n\n/**\n * highlights the current chapter based on current page\n * @private\n * @param {TocEntry[]} tocEntries\n * @param {number} tocEntries\n */\nBookReader.prototype.updateTOCState = function(currIndex, tocEntries) {\n  //this function won't have any effects if called before OpenLibrary request is finished\n  if (!tocEntries) {return;}\n  $('.current-chapter').removeClass('current-chapter');\n  const tocEntriesIndexed = tocEntries.filter((el) => el.pageIndex != undefined).reverse();\n  const currChapter = tocEntriesIndexed[tocEntriesIndexed.findIndex(\n    (el) => el.pageIndex <= currIndex)];\n  if (currChapter != undefined) {\n    $(currChapter.mobileHTML).addClass('current-chapter');\n  }\n};\n","'use strict';\nvar $ = require('../internals/export');\nvar isArray = require('../internals/is-array');\n\nvar nativeReverse = [].reverse;\nvar test = [1, 2];\n\n// `Array.prototype.reverse` method\n// https://tc39.es/ecma262/#sec-array.prototype.reverse\n// fix for Safari 12.0 bug\n// https://bugs.webkit.org/show_bug.cgi?id=188794\n$({ target: 'Array', proto: true, forced: String(test) === String(test.reverse()) }, {\n  reverse: function reverse() {\n    // eslint-disable-next-line no-self-assign -- dirty hack\n    if (isArray(this)) this.length = this.length;\n    return nativeReverse.call(this);\n  }\n});\n"],"names":["super_","jQuery","extend","BookReader","defaultOptions","olHost","enableChaptersPlugin","bookId","prototype","setup","options","call","this","init","ui","getOpenLibraryRecord","enableMobileNav","bind","eventNames","mobileNavOpen","updateTOCState","firstIndex","_tocEntries","$","parent","hasClass","on","addChapter","chapterTitle","pageNumber","pageIndex","percentThrough","util","cssPercentage","getNumLeafs","jumpToChapter","event","jumpToIndex","delegateTarget","data","removeClass","addClass","title","pageStr","mobileChapter","append","text","appendTo","undefined","css","left","marker","currentTarget","tooltip","querySelector","tooltipOffset","getBoundingClientRect","targetOffset","boxSizeAdjust","parseInt","getComputedStyle","paddingLeft","x","style","setProperty","target","attr","removeChapters","remove","updateTOC","tocEntries","length","show","i","addChapterFromEntry","children","each","el","mobileHTML","tocEntryObject","getPageIndex","chapterStr","label","filter","join","$el","baseURL","fetchUrlByBookId","ajax","url","dataType","then","olObject","table_of_contents","buildMobileDrawerElement","find","after","imagesBaseURL","hide","currIndex","tocEntriesIndexed","reverse","currChapter","findIndex","isArray","nativeReverse","test","proto","forced","String"],"sourceRoot":""}