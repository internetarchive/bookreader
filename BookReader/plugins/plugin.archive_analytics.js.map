{"version":3,"file":"plugins/plugin.archive_analytics.js","mappings":"mJAUsCA,E,wBAN/BC,OAAOC,WAAWC,eAAgB,CACvCC,wBAAwB,EAExBC,uBAAuB,IAGzBH,WAAWI,UAAUC,MAAiBP,EAQnCE,WAAWI,UAAUC,KAPf,WAAW,IAAAC,EAAA,KAChBR,EAAOS,KAAKC,MAERA,KAAKC,QAAQP,wBACfM,KAAKE,KAAKV,WAAWW,WAAWC,gBAAgB,kBAAMN,EAAKO,oCAAoC,GAEnG,GAIFb,WAAWI,UAAUS,mCAAqC,WACxD,GAAKC,OAAOC,kBAAZ,CAIA,IAAMC,EAAeR,KAAKK,mCAAmCG,aAEvDC,EAAST,KAAKU,oBACdC,EAAcX,KAAKY,mBAAmBH,GAE5C,GAAID,GAAgBG,EAAa,CAC/B,IAAME,EAAS,CACbC,WAAY,oBACZC,OAAQf,KAAKgB,OACbC,WAAYC,KAAKC,SAGnBN,QAAiB,EACjBA,QAAiB,GACjB,IACEA,EAAOO,QAAUd,OAAOe,IAAIC,SAASC,SAASC,MAAM,kBAChD,EACA,EACJX,EAAOY,SACJZ,EAAOO,SAAWd,OAAOe,IAAIC,SAASI,SAASF,MAAM,gBAClD,EACA,CACR,CAAE,MAAOG,GAAI,CAIbrB,OAAOC,kBAAkBqB,UAAUf,EAAQ,KAAM,uBAGjD,IAAMgB,EAAwB7B,KAAKC,QAAQ6B,aAAe9B,KAAKC,QAAQ6B,YAAYC,OAC/E,CAAEA,OAAQ/B,KAAKC,QAAQ6B,YAAYC,QACnC,CAAC,EACLzB,OAAOC,kBAAkByB,WAAW,aAAc,kBAAmB1B,OAAOgB,SAASI,SAAUG,GAE/F7B,KAAKK,mCAAmCG,aAAeG,CACzD,CArCA,CAsCF,EASAnB,WAAWI,UAAUqC,0BAA4B,SAASC,EAAUC,EAAQC,EAAOP,GAC5E7B,KAAKC,QAAQP,yBAEdM,KAAKC,QAAQN,uBACf0C,QAAQC,IAAI,4BAA6BC,UAAWjC,OAAOC,mBAGxDD,OAAOC,oBAEZsB,EAAwBA,GAAyB,CAAC,EAC7B,iBAAVO,IACTP,EAAsBW,GAAKJ,GAE7B9B,OAAOC,kBAAkByB,WAAWE,EAAUC,EAAQ,KAAMN,IAC9D,C","sources":["webpack://@internetarchive/bookreader/./src/plugins/plugin.archive_analytics.js"],"sourcesContent":["/* global BookReader */\n/**\n * Plugin for Archive.org analytics\n */\njQuery.extend(BookReader.defaultOptions, {\n  enableArchiveAnalytics: true,\n  /** Provide a means of debugging, cause otherwise it's impossible to test locally */\n  debugArchiveAnaltyics: false,\n});\n\nBookReader.prototype.init = (function(super_) {\n  return function() {\n    super_.call(this);\n\n    if (this.options.enableArchiveAnalytics) {\n      this.bind(BookReader.eventNames.fragmentChange, () => this.archiveAnalyticsSendFragmentChange());\n    }\n  };\n})(BookReader.prototype.init);\n\n/** @private */\nBookReader.prototype.archiveAnalyticsSendFragmentChange = function() {\n  if (!window.archive_analytics) {\n    return;\n  }\n\n  const prevFragment = this.archiveAnalyticsSendFragmentChange.prevFragment;\n\n  const params = this.paramsFromCurrent();\n  const newFragment = this.fragmentFromParams(params);\n\n  if (prevFragment != newFragment) {\n    const values = {\n      bookreader: \"user_changed_view\",\n      itemid: this.bookId,\n      cache_bust: Math.random(),\n    };\n    // EEK!  offsite embedding and /details/ page books look the same in analytics, otherwise!\n    values.offsite = 1;\n    values.details = 0;\n    try {\n      values.offsite = window.top.location.hostname.match(/\\.archive.org$/)\n        ? 0\n        : 1;\n      values.details =\n        !values.offsite && window.top.location.pathname.match(/^\\/details\\//)\n          ? 1\n          : 0;\n    } catch (e) {}\n    // avoids embed cross site exceptions -- but on (+) side, means it is and keeps marked offite!\n\n    // Send bookreader ping\n    window.archive_analytics.send_ping(values, null, \"augment_for_ao_site\");\n\n    // Also send tracking event ping\n    const additionalEventParams = this.options.lendingInfo && this.options.lendingInfo.loanId\n      ? { loanId: this.options.lendingInfo.loanId }\n      : {};\n    window.archive_analytics.send_event('BookReader', 'UserChangedView', window.location.pathname, additionalEventParams);\n\n    this.archiveAnalyticsSendFragmentChange.prevFragment = newFragment;\n  }\n};\n\n/**\n * Sends a tracking \"Event\". See https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#events\n * @param {string} category\n * @param {string} action\n * @param {number} [value] (must be an int)\n * @param {Object} [additionalEventParams]\n */\nBookReader.prototype.archiveAnalyticsSendEvent = function(category, action, value, additionalEventParams) {\n  if (!this.options.enableArchiveAnalytics) return;\n\n  if (this.options.debugArchiveAnaltyics) {\n    console.log(\"archiveAnalyticsSendEvent\", arguments, window.archive_analytics);\n  }\n\n  if (!window.archive_analytics) return;\n\n  additionalEventParams = additionalEventParams || {};\n  if (typeof(value) == 'number') {\n    additionalEventParams.ev = value;\n  }\n  window.archive_analytics.send_event(category, action, null, additionalEventParams);\n};\n"],"names":["super_","extend","BookReader","defaultOptions","enableArchiveAnalytics","debugArchiveAnaltyics","prototype","init","_this","call","this","options","bind","eventNames","fragmentChange","archiveAnalyticsSendFragmentChange","window","archive_analytics","prevFragment","params","paramsFromCurrent","newFragment","fragmentFromParams","values","bookreader","itemid","bookId","cache_bust","Math","random","offsite","top","location","hostname","match","details","pathname","e","send_ping","additionalEventParams","lendingInfo","loanId","send_event","archiveAnalyticsSendEvent","category","action","value","console","log","arguments","ev"],"sourceRoot":""}